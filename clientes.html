// En clientes.html - después de cargar supabase.js
<script type="module">
    import './supabase.js'

    let clientes = []

    // Cargar clientes desde Supabase
    async function cargarClientes() {
        try {
            const loader = document.getElementById('loadingClientes')
            if (loader) loader.classList.remove('hidden')
            
            clientes = await ClientesService.obtenerClientes()
            renderClientes(clientes)
            
            if (loader) loader.classList.add('hidden')
        } catch (error) {
            console.error('Error cargando clientes:', error)
            mostrarNotificacion('❌ Error cargando clientes', 'error')
        }
    }

    // Renderizar clientes en la grid
    function renderClientes(clientesArray = clientes) {
        const grid = document.getElementById('clientsGrid')
        if (!grid) return
        
        grid.innerHTML = ''

        if (clientesArray.length === 0) {
            grid.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-500">No hay clientes registrados</h3>
                    <p class="text-gray-400">Comienza agregando tu primer cliente</p>
                </div>
            `
            return
        }

        clientesArray.forEach(cliente => {
            const statusColor = {
                active: 'bg-green-100 text-green-800',
                inactive: 'bg-gray-100 text-gray-800',
                expired: 'bg-red-100 text-red-800'
            }
            
            const statusText = {
                active: 'Activo',
                inactive: 'Inactivo',
                expired: 'Vencido'
            }

            const clientCard = document.createElement('div')
            clientCard.className = 'client-card card rounded-xl p-6 cursor-pointer'
            clientCard.onclick = () => openClientDetails(cliente)

            clientCard.innerHTML = `
                <div class="flex items-center space-x-4 mb-4">
                    <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                        <span class="text-white font-medium">${getInitials(cliente.nombre)}</span>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-800">${cliente.nombre}</h3>
                        <p class="text-sm text-gray-600">${cliente.membresia || 'Sin membresía'}</p>
                    </div>
                    <span class="px-3 py-1 ${statusColor[cliente.estado || 'active']} text-xs rounded-full">
                        ${statusText[cliente.estado || 'active']}
                    </span>
                </div>
                
                <div class="space-y-2 text-sm">
                    <div class="flex items-center text-gray-600">
                        <i class="fas fa-envelope mr-2 w-4"></i>
                        <span>${cliente.email || 'Sin email'}</span>
                    </div>
                    <div class="flex items-center text-gray-600">
                        <i class="fas fa-phone mr-2 w-4"></i>
                        <span>${cliente.telefono || 'Sin teléfono'}</span>
                    </div>
                    <div class="flex items-center text-gray-600">
                        <i class="fas fa-calendar mr-2 w-4"></i>
                        <span>Ingreso: ${new Date(cliente.fecha_registro).toLocaleDateString()}</span>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-2 mt-4">
                    <button onclick="event.stopPropagation(); editarCliente('${cliente.id}')" 
                            class="px-3 py-1 bg-blue-100 text-blue-700 text-xs rounded-lg hover:bg-blue-200">
                        <i class="fas fa-edit mr-1"></i>Editar
                    </button>
                    <button onclick="event.stopPropagation(); verProgreso('${cliente.id}')" 
                            class="px-3 py-1 bg-green-100 text-green-700 text-xs rounded-lg hover:bg-green-200">
                        <i class="fas fa-chart-line mr-1"></i>Progreso
                    </button>
                </div>
            `
            
            grid.appendChild(clientCard)
        })
    }

    // Función para crear nuevo cliente
    async function crearCliente(clienteData) {
        try {
            const nuevoCliente = await ClientesService.crearCliente({
                nombre: clienteData.fullName,
                email: clienteData.email,
                telefono: clienteData.phone,
                fecha_nacimiento: clienteData.birthDate,
                genero: clienteData.gender,
                ocupacion: clienteData.occupation,
                experiencia_ejercicio: clienteData.hasExerciseExperience,
                contacto_emergencia: clienteData.emergencyContact,
                telefono_emergencia: clienteData.emergencyPhone,
                alergias: clienteData.allergies,
                condiciones_medicas: clienteData.medicalConditions,
                tipo_membresia: clienteData.membershipType,
                estado: 'active',
                fecha_registro: new Date().toISOString()
            })

            mostrarNotificacion('✅ Cliente creado exitosamente', 'success')
            await cargarClientes() // Recargar la lista
            return nuevoCliente
            
        } catch (error) {
            console.error('Error creando cliente:', error)
            mostrarNotificacion('❌ Error creando cliente', 'error')
            throw error
        }
    }

    // Helper functions
    function getInitials(name) {
        return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
    }

    function mostrarNotificacion(mensaje, tipo = 'info') {
        // Tu código de notificaciones existente
        alert(mensaje) // Temporal
    }

    // Modal functions (mantener tus funciones existentes)
    function openNewClientModal() {
        document.getElementById('newClientModal').classList.remove('hidden')
        document.getElementById('newClientModal').classList.add('flex')
    }

    function closeNewClientModal() {
        document.getElementById('newClientModal').classList.add('hidden')
        document.getElementById('newClientModal').classList.remove('flex')
        document.getElementById('newClientForm').reset()
    }

    // Form submission actualizado
    document.getElementById('newClientForm').addEventListener('submit', async function(e) {
        e.preventDefault()
        
        try {
            const formData = new FormData(this)
            const clientData = Object.fromEntries(formData)
            
            await crearCliente(clientData)
            closeNewClientModal()
            
        } catch (error) {
            // Error ya manejado en crearCliente
        }
    })

    // Inicializar página
    document.addEventListener('DOMContentLoaded', async function() {
        // Probar conexión
        const connected = await testConnection()
        if (!connected) {
            mostrarNotificacion('⚠️ Sin conexión a la base de datos', 'warning')
        }
        
        await cargarClientes()
        
        // Animaciones
        anime({
            targets: '.fade-in',
            translateY: [30, 0],
            opacity: [0, 1],
            delay: anime.stagger(150),
            duration: 600,
            easing: 'easeOutExpo'
        })
    })

    // Funciones placeholder (para desarrollar después)
    function openClientDetails(cliente) {
        alert(`Detalles de ${cliente.nombre}\n\nID: ${cliente.id}\nFuncionalidad en desarrollo...`)
    }

    function editarCliente(clienteId) {
        alert(`Editando cliente ID: ${clienteId}\n\nFuncionalidad en desarrollo...`)
    }

    function verProgreso(clienteId) {
        alert(`Viendo progreso del cliente ID: ${clienteId}\n\nFuncionalidad en desarrollo...`)
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase()
        const filteredClients = clientes.filter(cliente => 
            cliente.nombre.toLowerCase().includes(searchTerm) ||
            cliente.email?.toLowerCase().includes(searchTerm) ||
            cliente.telefono?.includes(searchTerm)
        )
        renderClientes(filteredClients)
    })
</script>
