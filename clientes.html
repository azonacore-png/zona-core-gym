<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - ZONA CORE</title>
    <!-- Tailwind CSS para desarrollo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuraci√≥n de Tailwind para evitar el warning
        tailwind.config = {
            important: true,
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Tus estilos CSS personalizados aqu√≠ */
        :root {
            --primary-blue: #2A5B8A;
            --neutral-gray: #5A5A5A;
            --accent-orange: #FF7A3C;
            --light-gray: #F8F9FA;
            --white: #FFFFFF;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .sidebar {
            background: linear-gradient(180deg, var(--primary-blue) 0%, #1e3a5f 100%);
            backdrop-filter: blur(10px);
        }
        
        .main-content {
            background: var(--light-gray);
            backdrop-filter: blur(10px);
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-orange) 0%, #ff6b2b 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 122, 60, 0.3);
        }
        
        .nav-item {
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .nav-item.active {
            background: rgba(255, 122, 60, 0.2);
            border-left: 4px solid var(--accent-orange);
        }
        
        .client-card {
            transition: all 0.3s ease;
        }
        
        .client-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .modal {
            backdrop-filter: blur(10px);
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Estilos para el modal de detalles del cliente */
        .client-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        @media (max-width: 768px) {
            .client-details-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .detail-item {
            margin-bottom: 1rem;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--neutral-gray);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .detail-value {
            color: #1f2937;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Estados de membres√≠a */
        .status-active { background-color: #dcfce7; color: #166534; }
        .status-inactive { background-color: #f3f4f6; color: #374151; }
        .status-expired { background-color: #fee2e2; color: #dc2626; }
        .status-paused { background-color: #fef3c7; color: #d97706; }
    </style>
</head>

<body>
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 text-white p-6 flex flex-col">
            <div class="mb-8">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center">
                        <i class="fas fa-dumbbell text-2xl" style="color: var(--primary-blue);"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">ZONA CORE</h1>
                        <p class="text-sm opacity-80">Admin Panel</p>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 space-y-2">
                <a href="index.html" class="nav-item flex items-center space-x-3 p-3 text-sm font-medium">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item active flex items-center space-x-3 p-3 text-sm font-medium">
                    <i class="fas fa-users"></i>
                    <span>Clientes</span>
                </a>
                <a href="pagos.html" class="nav-item flex items-center space-x-3 p-3 text-sm font-medium">
                    <i class="fas fa-credit-card"></i>
                    <span>Pagos</span>
                </a>
                <a href="clases.html" class="nav-item flex items-center space-x-3 p-3 text-sm font-medium">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Clases</span>
                </a>
                <a href="progreso.html" class="nav-item flex items-center space-x-3 p-3 text-sm font-medium">
                    <i class="fas fa-chart-line"></i>
                    <span>Progreso</span>
                </a>
                <a href="ejercicios.html" class="nav-item flex items-center space-x-3 p-3 text-sm font-medium">
                    <i class="fas fa-book"></i>
                    <span>Biblioteca</span>
                </a>
                <a href="reportes.html" class="nav-item flex items-center space-x-3 p-3 text-sm font-medium">
                    <i class="fas fa-file-alt"></i>
                    <span>Reportes</span>
                </a>
                <a href="configuracion.html" class="nav-item flex items-center space-x-3 p-3 text-sm font-medium">
                    <i class="fas fa-cog"></i>
                    <span>Configuraci√≥n</span>
                </a>
            </nav>
            
            <div class="mt-auto">
                <div class="bg-white bg-opacity-10 rounded-lg p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium">Administrador</p>
                            <p class="text-xs opacity-80">ZONA CORE</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b border-gray-200">
                <div class="px-6 py-4 flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-800">Gesti√≥n de Clientes</h2>
                        <p class="text-gray-600">Administra todos los clientes de ZONA CORE</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="openNewClientModal()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium">
                            <i class="fas fa-plus mr-2"></i>Nuevo Cliente
                        </button>
                        <div class="relative">
                            <button class="p-2 text-gray-600 hover:text-gray-800">
                                <i class="fas fa-bell text-xl"></i>
                                <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">3</span>
                            </button>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Content -->
            <main class="flex-1 overflow-y-auto p-6">
                <!-- Connection Status -->
                <div id="connectionStatus" class="hidden mb-4">
                    <!-- Se mostrar√° el estado de conexi√≥n aqu√≠ -->
                </div>
                
                <!-- Filters -->
                <div class="card rounded-xl p-6 mb-6 fade-in">
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="flex-1 min-w-64">
                            <input type="text" id="searchInput" placeholder="Buscar cliente..." 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Todos los estados</option>
                            <option value="activa">Activos</option>
                            <option value="inactiva">Inactivos</option>
                            <option value="vencida">Vencidos</option>
                            <option value="pausada">Pausados</option>
                        </select>
                        <select id="membershipFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Todas las membres√≠as</option>
                            <option value="mensualidad">Mensual</option>
                            <option value="trimestral">Trimestral</option>
                            <option value="semestral">Semestral</option>
                            <option value="anualidad">Anual</option>
                        </select>
                        <button onclick="applyFilters()" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            <i class="fas fa-filter mr-2"></i>Filtrar
                        </button>
                        <button onclick="clearFilters()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            <i class="fas fa-times mr-2"></i>Limpiar
                        </button>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div id="loadingState" class="flex justify-center items-center py-12">
                    <div class="text-center">
                        <div class="loading mx-auto mb-4"></div>
                        <p class="text-gray-600">Cargando clientes...</p>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="hidden text-center py-12">
                    <i class="fas fa-users text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">No hay clientes registrados</h3>
                    <p class="text-gray-500 mb-6">Comienza agregando tu primer cliente al sistema.</p>
                    <button onclick="openNewClientModal()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium">
                        <i class="fas fa-plus mr-2"></i>Agregar Primer Cliente
                    </button>
                </div>
                
                <!-- Clients Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 fade-in hidden" id="clientsGrid">
                    <!-- Client cards will be dynamically generated from Supabase -->
                </div>
            </main>
        </div>
    </div>
    
    <!-- New Client Modal -->
    <div id="newClientModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="newClientModalTitle">Nuevo Cliente</h3>
                <button onclick="closeNewClientModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="newClientForm" class="space-y-6">
                <input type="hidden" id="editClientId" name="clientId">
                
                <!-- Personal Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                        <input type="text" name="nombre" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" name="email" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono *</label>
                        <input type="tel" name="telefono" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Nacimiento</label>
                        <input type="date" name="fecha_nacimiento" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sexo</label>
                        <select name="genero" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Seleccionar</option>
                            <option value="femenino">Femenino</option>
                            <option value="masculino">Masculino</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ocupaci√≥n</label>
                        <input type="text" name="ocupacion" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                
                <!-- Exercise Experience -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">¬øHa hecho ejercicio antes? *</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="experiencia_ejercicio" value="true" class="mr-2">
                            <span>S√≠</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="experiencia_ejercicio" value="false" class="mr-2" checked>
                            <span>No</span>
                        </label>
                    </div>
                </div>
                
                <!-- Emergency Contact -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contacto de Emergencia</label>
                        <input type="text" name="contacto_emergencia" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tel. Emergencia</label>
                        <input type="tel" name="telefono_emergencia" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                
                <!-- Medical Information -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Alergias</label>
                    <textarea name="alergias" rows="2" 
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Listar alergias conocidas..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Condiciones M√©dicas</label>
                    <textarea name="condiciones_medicas" rows="2" 
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Describir condiciones m√©dicas relevantes..."></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Restricciones M√©dicas</label>
                    <textarea name="restricciones_medicas" rows="2" 
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Describir restricciones m√©dicas..."></textarea>
                </div>
                
                <!-- Membership Type -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Membres√≠a *</label>
                        <select name="membresia_tipo" required 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Seleccionar membres√≠a</option>
                            <option value="mensualidad">Mensual - $80</option>
                            <option value="trimestral">Trimestral - $220</option>
                            <option value="semestral">Semestral - $420</option>
                            <option value="anualidad">Anual - $800</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estado *</label>
                        <select name="estado" required 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="activa">Activa</option>
                            <option value="inactiva">Inactiva</option>
                            <option value="vencida">Vencida</option>
                            <option value="pausada">Pausada</option>
                        </select>
                    </div>
                </div>

                <!-- Fechas importantes -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Ingreso</label>
                        <input type="date" name="fecha_ingreso" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pr√≥ximo Pago</label>
                        <input type="date" name="proximo_pago" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>

                <!-- Observaciones -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Observaciones</label>
                    <textarea name="observaciones" rows="3" 
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Observaciones adicionales..."></textarea>
                </div>
                
                <!-- Form Actions -->
                <div class="flex justify-end space-x-4 pt-6">
                    <button type="button" onclick="closeNewClientModal()" 
                            class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" id="submitButton" 
                            class="btn-primary text-white px-6 py-2 rounded-lg font-medium">
                        <i class="fas fa-save mr-2"></i><span id="submitButtonText">Guardar Cliente</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Client Details Modal -->
    <div id="clientDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Detalles del Cliente</h3>
                <button onclick="closeClientDetailsModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="clientDetailsContent" class="client-details-grid">
                <!-- Los detalles del cliente se cargar√°n aqu√≠ din√°micamente desde Supabase -->
            </div>
            
            <div class="flex justify-end space-x-4 pt-6 mt-6 border-t border-gray-200">
                <button onclick="closeClientDetailsModal()" 
                        class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Cerrar
                </button>
                <button id="editClientBtn" class="btn-primary text-white px-6 py-2 rounded-lg font-medium">
                    <i class="fas fa-edit mr-2"></i>Editar Cliente
                </button>
                <button id="deleteClientBtn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">
                    <i class="fas fa-trash mr-2"></i>Eliminar
                </button>
            </div>
        </div>
    </div>

    <!-- Incluir el archivo supabase.js externo -->
    <script type="module">
        // Importar desde el archivo externo supabase.js
        import { ClientesService, testConnection, diagnosticarRLS } from './supabase.js';
        
        // Exportar al scope global para las funciones del HTML
        window.ClientesService = ClientesService;
        window.testConnection = testConnection;
        window.diagnosticarRLS = diagnosticarRLS;
        
        // Variables globales
        let allClients = [];
        let currentClientId = null;
        let isEditing = false;

        // Cargar clientes desde Supabase - VERSI√ìN SIMPLIFICADA
        async function loadClients() {
            try {
                console.log('üîÑ Cargando clientes...');
                showLoadingState();
                
                const clients = await ClientesService.obtenerClientes();
                console.log('üì• Clientes recibidos:', clients);
                
                allClients = clients;
                renderClients(clients);
                
            } catch (error) {
                console.error('‚ùå Error cargando clientes:', error);
                
                let errorMessage = error.message;
                
                showNotification('Error al cargar los clientes: ' + errorMessage, 'error');
                
                // Mostrar estado de error
                const grid = document.getElementById('clientsGrid');
                const loadingState = document.getElementById('loadingState');
                const emptyState = document.getElementById('emptyState');
                
                loadingState.classList.add('hidden');
                grid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                emptyState.innerHTML = `
                    <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Error al cargar clientes</h3>
                    <p class="text-gray-500 mb-4">${errorMessage}</p>
                    <button onclick="loadClients()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium">
                        <i class="fas fa-redo mr-2"></i>Reintentar
                    </button>
                `;
            }
        }

    // FUNCI√ìN FALTANTE: Renderizar clientes en la grid
    function renderClients(clients) {
        const grid = document.getElementById('clientsGrid');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        
        loadingState.classList.add('hidden');
        
        if (!clients || clients.length === 0) {
            grid.classList.add('hidden');
            emptyState.classList.remove('hidden');
            return;
        }
        
        emptyState.classList.add('hidden');
        grid.classList.remove('hidden');
        
        grid.innerHTML = clients.map(client => `
            <div class="client-card bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden fade-in">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                <span class="font-semibold text-blue-600">${getInitials(client.nombre)}</span>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">${client.nombre}</h3>
                                <p class="text-sm text-gray-600">${client.email}</p>
                            </div>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusClass(client.estado)}">
                            ${getStatusText(client.estado)}
                        </span>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-phone-alt w-4 mr-2"></i>
                            <span>${client.telefono || 'No especificado'}</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-calendar-alt w-4 mr-2"></i>
                            <span>${formatMembershipType(client.membresia_tipo)}</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-clock w-4 mr-2"></i>
                            <span>Pr√≥ximo pago: ${formatDate(client.proximo_pago)}</span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="openClientDetails(${JSON.stringify(client).replace(/"/g, '&quot;')})" 
                                class="flex-1 bg-blue-500 text-white py-2 px-3 rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors">
                            <i class="fas fa-eye mr-1"></i>Ver
                        </button>
                        <button onclick="viewProgress('${client.id}')" 
                                class="flex-1 bg-green-500 text-white py-2 px-3 rounded-lg text-sm font-medium hover:bg-green-600 transition-colors">
                            <i class="fas fa-chart-line mr-1"></i>Progreso
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Modal functions
    function openNewClientModal() {
        isEditing = false;
        document.getElementById('newClientModalTitle').textContent = 'Nuevo Cliente';
        document.getElementById('submitButtonText').textContent = 'Guardar Cliente';
        document.getElementById('editClientId').value = '';
        
        // Set default dates
        const today = new Date().toISOString().split('T')[0];
        document.querySelector('input[name="fecha_ingreso"]').value = today;
        document.querySelector('input[name="proximo_pago"]').value = calculateNextPayment('mensualidad');
        
        document.getElementById('newClientModal').classList.remove('hidden');
        document.getElementById('newClientModal').classList.add('flex');
    }
    
    function closeNewClientModal() {
        const modal = document.getElementById('newClientModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.getElementById('newClientForm').reset();
        isEditing = false;
        currentClientId = null;
    }

    // Client Details Modal
    function openClientDetails(client) {
        currentClientId = client.id;
        const modal = document.getElementById('clientDetailsModal');
        const content = document.getElementById('clientDetailsContent');
        
        content.innerHTML = `
            <div>
                <div class="detail-item">
                    <div class="detail-label">Nombre Completo</div>
                    <div class="detail-value">${client.nombre}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Email</div>
                    <div class="detail-value">${client.email}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Tel√©fono</div>
                    <div class="detail-value">${client.telefono || 'No especificado'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Fecha de Nacimiento</div>
                    <div class="detail-value">${formatDate(client.fecha_nacimiento)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Sexo</div>
                    <div class="detail-value">${getGenderText(client.genero)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Ocupaci√≥n</div>
                    <div class="detail-value">${client.ocupacion || 'No especificada'}</div>
                </div>
            </div>
            <div>
                <div class="detail-item">
                    <div class="detail-label">Experiencia en Ejercicio</div>
                    <div class="detail-value">${client.experiencia_ejercicio ? 'S√≠' : 'No'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Contacto Emergencia</div>
                    <div class="detail-value">${client.contacto_emergencia || 'No especificado'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Tel. Emergencia</div>
                    <div class="detail-value">${client.telefono_emergencia || 'No especificado'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Tipo de Membres√≠a</div>
                    <div class="detail-value">${formatMembershipType(client.membresia_tipo)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Estado</div>
                    <div class="detail-value">
                        <span class="px-2 py-1 rounded-full text-xs ${getStatusClass(client.estado)}">
                            ${getStatusText(client.estado)}
                        </span>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Fecha de Ingreso</div>
                    <div class="detail-value">${formatDate(client.fecha_ingreso)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Pr√≥ximo Pago</div>
                    <div class="detail-value">${formatDate(client.proximo_pago)}</div>
                </div>
            </div>
            ${client.alergias || client.condiciones_medicas || client.restricciones_medicas ? `
            <div class="col-span-2">
                <div class="detail-item">
                    <div class="detail-label">Alergias</div>
                    <div class="detail-value">${client.alergias || 'Ninguna'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Condiciones M√©dicas</div>
                    <div class="detail-value">${client.condiciones_medicas || 'Ninguna'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Restricciones M√©dicas</div>
                    <div class="detail-value">${client.restricciones_medicas || 'Ninguna'}</div>
                </div>
            </div>
            ` : ''}
            ${client.observaciones ? `
            <div class="col-span-2">
                <div class="detail-item">
                    <div class="detail-label">Observaciones</div>
                    <div class="detail-value">${client.observaciones}</div>
                </div>
            </div>
            ` : ''}
        `;
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
    
    function closeClientDetailsModal() {
        const modal = document.getElementById('clientDetailsModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        currentClientId = null;
    }

    // FUNCIONES FALTANTES: Para los botones del modal de detalles
    function editClientFromDetails() {
        if (currentClientId) {
            editClient(currentClientId);
        }
    }

    function deleteClientFromDetails() {
        if (currentClientId) {
            deleteClient(currentClientId);
        }
    }

    // Edit Client
    async function editClient(clientId) {
        try {
            const client = allClients.find(c => c.id === clientId);
            if (!client) {
                throw new Error('Cliente no encontrado');
            }

            isEditing = true;
            currentClientId = clientId;
            
            document.getElementById('newClientModalTitle').textContent = 'Editar Cliente';
            document.getElementById('submitButtonText').textContent = 'Actualizar Cliente';
            document.getElementById('editClientId').value = clientId;

            // Llenar el formulario con los datos del cliente
            const form = document.getElementById('newClientForm');
            form.nombre.value = client.nombre || '';
            form.email.value = client.email || '';
            form.telefono.value = client.telefono || '';
            form.fecha_nacimiento.value = client.fecha_nacimiento || '';
            form.genero.value = client.genero || '';
            form.ocupacion.value = client.ocupacion || '';
            form.experiencia_ejercicio.value = client.experiencia_ejercicio ? 'true' : 'false';
            form.contacto_emergencia.value = client.contacto_emergencia || '';
            form.telefono_emergencia.value = client.telefono_emergencia || '';
            form.alergias.value = client.alergias || '';
            form.condiciones_medicas.value = client.condiciones_medicas || '';
            form.restricciones_medicas.value = client.restricciones_medicas || '';
            form.membresia_tipo.value = client.membresia_tipo || '';
            form.estado.value = client.estado || 'activa';
            form.fecha_ingreso.value = client.fecha_ingreso || '';
            form.proximo_pago.value = client.proximo_pago || '';
            form.observaciones.value = client.observaciones || '';

            closeClientDetailsModal();
            openNewClientModal();
        } catch (error) {
            console.error('Error cargando datos del cliente:', error);
            showNotification('Error al cargar datos del cliente: ' + error.message, 'error');
        }
    }

    // Delete Client
    async function deleteClient(clientId) {
        if (!confirm('¬øEst√°s seguro de que quieres eliminar este cliente? Esta acci√≥n no se puede deshacer.')) {
            return;
        }

        try {
            await ClientesService.eliminarCliente(clientId);
            showNotification('Cliente eliminado exitosamente', 'success');
            closeClientDetailsModal();
            await loadClients();
        } catch (error) {
            console.error('Error eliminando cliente:', error);
            showNotification('Error al eliminar el cliente: ' + error.message, 'error');
        }
    }

    // Form submission - VERSI√ìN CORREGIDA Y COMPLETA
    document.getElementById('newClientForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        console.log('=== INICIANDO GUARDADO ===');
        
        const submitButton = document.getElementById('submitButton');
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<div class="loading"></div> Procesando...';
        submitButton.disabled = true;
        
        try {
            // Get form data
            const formData = new FormData(this);
            const clientData = Object.fromEntries(formData);
            const clientId = document.getElementById('editClientId').value; // CORREGIDO: obtener del campo hidden
    
            console.log('üìã Datos del formulario:', clientData);
            console.log('üÜî ID del cliente (edici√≥n):', clientId);
            console.log('‚úèÔ∏è Modo edici√≥n:', isEditing);
            
            // Preparar datos COMPATIBLES con la estructura de la tabla
            const clientInfo = {
                nombre: clientData.nombre,
                email: clientData.email,
                telefono: clientData.telefono,
                fecha_nacimiento: clientData.fecha_nacimiento || null,
                genero: clientData.genero || null,
                ocupacion: clientData.ocupacion || null,
                experiencia_ejercicio: clientData.experiencia_ejercicio === 'true',
                contacto_emergencia: clientData.contacto_emergencia || null,
                telefono_emergencia: clientData.telefono_emergencia || null,
                alergias: clientData.alergias || null,
                condiciones_medicas: clientData.condiciones_medicas || null,
                restricciones_medicas: clientData.restricciones_medicas || null,
                membresia_tipo: clientData.membresia_tipo,
                estado: clientData.estado,
                fecha_ingreso: clientData.fecha_ingreso || new Date().toISOString().split('T')[0],
                proximo_pago: clientData.proximo_pago || calculateNextPayment(clientData.membresia_tipo),
                observaciones: clientData.observaciones || null
            };

            console.log('üéØ Datos preparados para Supabase:', clientInfo);

            let savedClient;
            if (isEditing && clientId) {
                console.log('‚úèÔ∏è Editando cliente existente...');
                savedClient = await ClientesService.actualizarCliente(clientId, clientInfo);
                showNotification('Cliente actualizado exitosamente!', 'success');
            } else {
                console.log('üÜï Creando nuevo cliente...');
                savedClient = await ClientesService.crearCliente(clientInfo);
                showNotification('Cliente agregado exitosamente!', 'success');
            }
            
            console.log('‚úÖ Operaci√≥n completada:', savedClient);
            
            // Recargar lista de clientes
            await loadClients();
            closeNewClientModal();
            
        } catch (error) {
            console.error('‚ùå ERROR DETALLADO:', error);
            console.error('üìÑ Stack trace:', error.stack);
            showNotification('Error: ' + error.message, 'error');

        // Manejar error espec√≠fico de duplicado de email
        if (error.message.includes('duplicate key value violates unique constraint "clientes_email_key"')) {
            showNotification('Error: Ya existe un cliente con ese email. Use un email diferente.', 'error');
        } else {
            showNotification('Error: ' + error.message, 'error');
            
        } finally {
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
            console.log('=== FINALIZADO ===');
        }
    });

    // CORREGIR tambi√©n la funci√≥n editClient para asegurar que el ID se establezca correctamente
    async function editClient(clientId) {
        try {
            const client = allClients.find(c => c.id === clientId);
            if (!client) {
                throw new Error('Cliente no encontrado');
            }
    
            isEditing = true;
            currentClientId = clientId;
            
            document.getElementById('newClientModalTitle').textContent = 'Editar Cliente';
            document.getElementById('submitButtonText').textContent = 'Actualizar Cliente';
            document.getElementById('editClientId').value = clientId; // ESTA L√çNEA ES CLAVE
    
            console.log('üîß Editando cliente ID:', clientId);
            console.log('üìß Email del cliente:', client.email);
    
            // Llenar el formulario con los datos del cliente
            const form = document.getElementById('newClientForm');
            form.nombre.value = client.nombre || '';
            form.email.value = client.email || '';
            form.telefono.value = client.telefono || '';
            form.fecha_nacimiento.value = client.fecha_nacimiento || '';
            form.genero.value = client.genero || '';
            form.ocupacion.value = client.ocupacion || '';
            
            // CORREGIR: Establecer el radio button correctamente
            const experienciaValue = client.experiencia_ejercicio ? 'true' : 'false';
            document.querySelector(`input[name="experiencia_ejercicio"][value="${experienciaValue}"]`).checked = true;
            
            form.contacto_emergencia.value = client.contacto_emergencia || '';
            form.telefono_emergencia.value = client.telefono_emergencia || '';
            form.alergias.value = client.alergias || '';
            form.condiciones_medicas.value = client.condiciones_medicas || '';
            form.restricciones_medicas.value = client.restricciones_medicas || '';
            form.membresia_tipo.value = client.membresia_tipo || '';
            form.estado.value = client.estado || 'activa';
            form.fecha_ingreso.value = client.fecha_ingreso || '';
            form.proximo_pago.value = client.proximo_pago || '';
            form.observaciones.value = client.observaciones || '';
    
            closeClientDetailsModal();
            openNewClientModal();
        } catch (error) {
            console.error('Error cargando datos del cliente:', error);
            showNotification('Error al cargar datos del cliente: ' + error.message, 'error');
        }
    }
    
    // AGREGAR validaci√≥n de email √∫nico antes de guardar
    async function validateUniqueEmail(email, currentClientId = null) {
        try {
            const clients = await ClientesService.obtenerClientes();
            const existingClient = clients.find(client => 
                client.email === email && client.id !== currentClientId
            );
            return !existingClient; // Retorna true si el email es √∫nico
        } catch (error) {
            console.error('Error validando email:', error);
            return true; // En caso de error, permitir el guardado
        }
    }

        // AGREGAR validaci√≥n en tiempo real para email
        document.querySelector('input[name="email"]').addEventListener('blur', async function() {
            const email = this.value;
            const clientId = document.getElementById('editClientId').value;
            
            if (email && clientId) {
                // Solo validar si estamos editando y el email ha cambiado
                const client = allClients.find(c => c.id === clientId);
                if (client && client.email !== email) {
                    const isUnique = await validateUniqueEmail(email, clientId);
                    if (!isUnique) {
                        showNotification('Este email ya est√° en uso por otro cliente', 'error');
                        this.focus();
                    }
                }
            }
        });

    // Filter functions
    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const membershipFilter = document.getElementById('membershipFilter').value;
        
        const filteredClients = allClients.filter(client => {
            const matchesSearch = 
                client.nombre.toLowerCase().includes(searchTerm) ||
                client.email.toLowerCase().includes(searchTerm) ||
                (client.telefono && client.telefono.includes(searchTerm));
            
            const matchesStatus = !statusFilter || (client.estado === statusFilter);
            const matchesMembership = !membershipFilter || (client.membresia_tipo === membershipFilter);
            
            return matchesSearch && matchesStatus && matchesMembership;
        });
        
        renderClients(filteredClients);
    }
    
    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('membershipFilter').value = '';
        renderClients(allClients);
    }

    // Helper functions
    function calculateNextPayment(membershipType) {
        const today = new Date();
        switch(membershipType) {
            case 'mensualidad':
                today.setMonth(today.getMonth() + 1);
                break;
            case 'trimestral':
                today.setMonth(today.getMonth() + 3);
                break;
            case 'semestral':
                today.setMonth(today.getMonth() + 6);
                break;
            case 'anualidad':
                today.setFullYear(today.getFullYear() + 1);
                break;
            default:
                today.setMonth(today.getMonth() + 1);
        }
        return today.toISOString().split('T')[0];
    }
    
    function getInitials(name) {
        return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    }
    
    function getGenderText(gender) {
        const genders = {
            'femenino': 'Femenino',
            'masculino': 'Masculino',
            'otro': 'Otro'
        };
        return genders[gender] || 'No especificado';
    }

    function formatMembershipType(type) {
        const types = {
            'mensualidad': 'Mensual',
            'trimestral': 'Trimestral',
            'semestral': 'Semestral',
            'anualidad': 'Anual'
        };
        return types[type] || type;
    }

    function formatDate(dateString) {
        if (!dateString) return 'No especificada';
        return new Date(dateString).toLocaleDateString('es-ES');
    }

    function getStatusClass(status) {
        const statusClass = {
            activa: 'status-active',
            inactiva: 'status-inactive',
            vencida: 'status-expired',
            pausada: 'status-paused'
        };
        return statusClass[status] || 'status-inactive';
    }

    function getStatusText(status) {
        const statusText = {
            activa: 'Activo',
            inactiva: 'Inactivo',
            vencida: 'Vencido',
            pausada: 'Pausado'
        };
        return statusText[status] || status;
    }

    function showLoadingState() {
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('clientsGrid').classList.add('hidden');
        document.getElementById('emptyState').classList.add('hidden');
    }
    
    function showNotification(message, type) {
        // Crear notificaci√≥n temporal
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        }`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'} mr-2"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Remover despu√©s de 3 segundos
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    function showConnectionStatus(type, message) {
        const statusDiv = document.getElementById('connectionStatus');
        statusDiv.className = `p-4 rounded-lg mb-4 ${
            type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 
            'bg-red-100 text-red-800 border border-red-200'
        }`;
        statusDiv.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} mr-2"></i>
                <span>${message}</span>
            </div>
        `;
        statusDiv.classList.remove('hidden');
    }
    
    function viewProgress(clientId) {
        alert(`Viendo progreso del cliente ID: ${clientId}\n\nFuncionalidad en desarrollo...`);
    }
    
    // Search functionality
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('membershipFilter').addEventListener('change', applyFilters);

    // INICIALIZACI√ìN COMPLETA CON EVENT LISTENERS FALTANTES
    document.addEventListener('DOMContentLoaded', async function() {
        // Test connection and load clients
        const connected = await testConnection();
        if (connected) {
            showConnectionStatus('success', 'Conectado a la base de datos');
            await loadClients();
        } else {
            showConnectionStatus('error', 'Error de conexi√≥n a la base de datos');
        }
        
        // Asignar las funciones correctas a los botones del modal de detalles
        document.getElementById('editClientBtn').addEventListener('click', editClientFromDetails);
        document.getElementById('deleteClientBtn').addEventListener('click', deleteClientFromDetails);
        
        // Cerrar modales al hacer click fuera del contenido
        document.getElementById('newClientModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeNewClientModal();
            }
        });
        
        document.getElementById('clientDetailsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeClientDetailsModal();
            }
        });
        
        // Cerrar modales con tecla Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeNewClientModal();
                closeClientDetailsModal();
            }
        });
        
        // Animate elements
        anime({
            targets: '.fade-in',
            translateY: [30, 0],
            opacity: [0, 1],
            delay: anime.stagger(150),
            duration: 600,
            easing: 'easeOutExpo'
        });
    });
    
    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const href = this.getAttribute('href');
            if (href && href !== '#') {
                window.location.href = href;
            }
        });
    });

    // Exportar funciones al scope global para que est√©n disponibles en los onclick
    window.openNewClientModal = openNewClientModal;
    window.closeNewClientModal = closeNewClientModal;
    window.openClientDetails = openClientDetails;
    window.closeClientDetailsModal = closeClientDetailsModal;
    window.editClientFromDetails = editClientFromDetails;
    window.deleteClientFromDetails = deleteClientFromDetails;
    window.editClient = editClient;
    window.deleteClient = deleteClient;
    window.applyFilters = applyFilters;
    window.clearFilters = clearFilters;
    window.viewProgress = viewProgress;
    window.loadClients = loadClients;
</script>
</body>
</html>
